<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Debug - GestureQuiz</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            display: inline-block;
        }
        
        .btn:hover {
            background: #1d4ed8;
        }
        
        .btn-success {
            background: #10b981;
        }
        
        .btn-warning {
            background: #f59e0b;
        }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #22c55e;
        }
        
        .status.error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #ef4444;
        }
        
        .status.info {
            background: #eff6ff;
            color: #2563eb;
            border: 1px solid #3b82f6;
        }
        
        .log {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .step {
            margin: 20px 0;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid #2563eb;
        }
        
        .step h3 {
            margin-top: 0;
            color: #1f2937;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Analytics Debug Tool</h1>
        
        <div class="status info">
            <strong>Purpose:</strong> Debug and test the analytics modal functionality
        </div>
        
        <div class="step">
            <h3>Step 1: Setup Test Environment</h3>
            <button class="btn" onclick="setupTestData()">Setup Test Data</button>
            <button class="btn btn-warning" onclick="clearAllData()">Clear All Data</button>
        </div>
        
        <div class="step">
            <h3>Step 2: Test Data Verification</h3>
            <button class="btn" onclick="verifyTestData()">Verify Test Data</button>
            <button class="btn" onclick="showStorageData()">Show Storage Data</button>
        </div>
        
        <div class="step">
            <h3>Step 3: Test Analytics</h3>
            <button class="btn btn-success" onclick="openQuizManagement()">Open Quiz Management</button>
            <button class="btn" onclick="testAnalyticsCalculations()">Test Analytics Calculations</button>
        </div>
        
        <div id="testResults"></div>
        
        <h3>Debug Log</h3>
        <div id="consoleLog" class="log"></div>
    </div>

    <script>
        let logMessages = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            logMessages.push(logEntry);
            
            const logElement = document.getElementById('consoleLog');
            logElement.innerHTML = logMessages.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }
        
        function showStatus(message, type = 'info') {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
            document.getElementById('testResults').appendChild(statusDiv);
        }
        
        function setupTestData() {
            log('=== SETTING UP TEST DATA ===');
            
            // Create test teacher account
            const testTeacher = {
                name: "Test Teacher",
                email: "teacher@example.com",
                role: "teacher"
            };
            localStorage.setItem('currentUser', JSON.stringify(testTeacher));
            log('‚úì Test teacher account created: teacher@example.com');
            
            // Create test quiz
            const testQuiz = {
                id: 1234567890,
                title: "Analytics Test Quiz",
                description: "A quiz created specifically to test analytics functionality",
                questions: [
                    {
                        id: 1,
                        question: "What is 2 + 2?",
                        choices: ["3", "4", "5", "6"],
                        correct: 1,
                        gesture: "thumbs-up"
                    },
                    {
                        id: 2,
                        question: "What is the capital of France?",
                        choices: ["London", "Berlin", "Paris", "Madrid"],
                        correct: 2,
                        gesture: "peace"
                    },
                    {
                        id: 3,
                        question: "What is 10 - 5?",
                        choices: ["3", "4", "5", "6"],
                        correct: 2,
                        gesture: "ok"
                    }
                ],
                category: "Test",
                difficulty: "easy",
                createdAt: new Date().toISOString(),
                createdBy: "teacher@example.com",
                status: "published",
                published: true,
                publishedAt: new Date().toISOString()
            };
            
            const quizzes = JSON.parse(localStorage.getItem('gestureQuizzes') || '[]');
            const existingIndex = quizzes.findIndex(q => q.id === testQuiz.id);
            if (existingIndex >= 0) {
                quizzes[existingIndex] = testQuiz;
                log('‚úì Test quiz updated (already existed)');
            } else {
                quizzes.push(testQuiz);
                log('‚úì Test quiz created');
            }
            localStorage.setItem('gestureQuizzes', JSON.stringify(quizzes));
            
            // Create diverse test results
            const testResults = [
                {
                    quizId: 1234567890,
                    quizTitle: "Analytics Test Quiz",
                    userEmail: "alice@student.com",
                    score: 100,
                    totalQuestions: 3,
                    correctAnswers: 3,
                    completedAt: new Date(Date.now() - 86400000).toISOString() // 1 day ago
                },
                {
                    quizId: 1234567890,
                    quizTitle: "Analytics Test Quiz",
                    userEmail: "bob@student.com",
                    score: 67,
                    totalQuestions: 3,
                    correctAnswers: 2,
                    completedAt: new Date(Date.now() - 172800000).toISOString() // 2 days ago
                },
                {
                    quizId: 1234567890,
                    quizTitle: "Analytics Test Quiz",
                    userEmail: "charlie@student.com",
                    score: 33,
                    totalQuestions: 3,
                    correctAnswers: 1,
                    completedAt: new Date(Date.now() - 259200000).toISOString() // 3 days ago
                },
                {
                    quizId: 1234567890,
                    quizTitle: "Analytics Test Quiz",
                    userEmail: "diana@student.com",
                    score: 100,
                    totalQuestions: 3,
                    correctAnswers: 3,
                    completedAt: new Date(Date.now() - 345600000).toISOString() // 4 days ago
                },
                {
                    quizId: 1234567890,
                    quizTitle: "Analytics Test Quiz",
                    userEmail: "eve@student.com",
                    score: 67,
                    totalQuestions: 3,
                    correctAnswers: 2,
                    completedAt: new Date(Date.now() - 432000000).toISOString() // 5 days ago
                }
            ];
            
            // Replace existing results for this quiz
            const existingResults = JSON.parse(localStorage.getItem('quizResults') || '[]');
            const filteredResults = existingResults.filter(r => r.quizId !== 1234567890);
            const newResults = [...filteredResults, ...testResults];
            localStorage.setItem('quizResults', JSON.stringify(newResults));
            log(`‚úì Test results created: ${testResults.length} student attempts`);
            
            showStatus('‚úÖ Test data setup complete! Quiz and results are ready for analytics testing.', 'success');
            log('=== TEST DATA SETUP COMPLETE ===');
        }
        
        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                localStorage.removeItem('gestureQuizzes');
                localStorage.removeItem('quizResults');
                localStorage.removeItem('currentUser');
                localStorage.removeItem('currentAnalyticsQuizId');
                log('‚úì All data cleared');
                showStatus('üóëÔ∏è All data cleared successfully!', 'success');
            }
        }
        
        function verifyTestData() {
            log('=== VERIFYING TEST DATA ===');
            
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const quizzes = JSON.parse(localStorage.getItem('gestureQuizzes') || '[]');
            const results = JSON.parse(localStorage.getItem('quizResults') || '[]');
            
            log(`Current user: ${currentUser.email || 'NOT SET'} (${currentUser.role || 'NO ROLE'})`);
            log(`Total quizzes: ${quizzes.length}`);
            log(`Total results: ${results.length}`);
            
            // Check for test quiz
            const testQuiz = quizzes.find(q => q.id === 1234567890);
            if (testQuiz) {
                log(`‚úì Test quiz found: "${testQuiz.title}" by ${testQuiz.createdBy}`);
                log(`  - Status: ${testQuiz.status}`);
                log(`  - Questions: ${testQuiz.questions.length}`);
            } else {
                log('‚ùå Test quiz NOT found');
            }
            
            // Check for test results
            const testResults = results.filter(r => r.quizId === 1234567890);
            if (testResults.length > 0) {
                log(`‚úì Test results found: ${testResults.length} attempts`);
                const scores = testResults.map(r => r.score);
                const avgScore = scores.reduce((a, b) => a + b, 0) / scores.length;
                log(`  - Average score: ${Math.round(avgScore)}%`);
                log(`  - Score range: ${Math.min(...scores)}% - ${Math.max(...scores)}%`);
            } else {
                log('‚ùå Test results NOT found');
            }
            
            if (testQuiz && testResults.length > 0) {
                showStatus('‚úÖ Test data verified successfully! Ready for analytics testing.', 'success');
            } else {
                showStatus('‚ùå Test data incomplete. Run "Setup Test Data" first.', 'error');
            }
            
            log('=== VERIFICATION COMPLETE ===');
        }
        
        function showStorageData() {
            log('=== SHOWING STORAGE DATA ===');
            
            const quizzes = JSON.parse(localStorage.getItem('gestureQuizzes') || '[]');
            const results = JSON.parse(localStorage.getItem('quizResults') || '[]');
            
            log('QUIZZES:');
            quizzes.forEach((quiz, index) => {
                log(`  ${index + 1}. ${quiz.title} (ID: ${quiz.id}) - ${quiz.status}`);
            });
            
            log('RESULTS:');
            results.forEach((result, index) => {
                log(`  ${index + 1}. Quiz ${result.quizId}: ${result.userEmail} - ${result.score}%`);
            });
            
            log('=== STORAGE DATA DISPLAY COMPLETE ===');
        }
        
        function testAnalyticsCalculations() {
            log('=== TESTING ANALYTICS CALCULATIONS ===');
            
            const quizResults = JSON.parse(localStorage.getItem('quizResults') || '[]');
            const testQuizResults = quizResults.filter(r => r.quizId === 1234567890);
            
            if (testQuizResults.length === 0) {
                log('‚ùå No test results found for calculations');
                showStatus('‚ùå No test results found. Run "Setup Test Data" first.', 'error');
                return;
            }
            
            // Calculate basic statistics
            const totalAttempts = testQuizResults.length;
            const scores = testQuizResults.map(r => r.score);
            const averageScore = Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
            const highestScore = Math.max(...scores);
            const lowestScore = Math.min(...scores);
            
            log(`Total attempts: ${totalAttempts}`);
            log(`Average score: ${averageScore}%`);
            log(`Highest score: ${highestScore}%`);
            log(`Lowest score: ${lowestScore}%`);
            
            // Calculate score distribution
            const distribution = {
                '90-100': 0,
                '80-89': 0,
                '70-79': 0,
                '60-69': 0,
                'below60': 0
            };
            
            scores.forEach(score => {
                if (score >= 90) distribution['90-100']++;
                else if (score >= 80) distribution['80-89']++;
                else if (score >= 70) distribution['70-79']++;
                else if (score >= 60) distribution['60-69']++;
                else distribution['below60']++;
            });
            
            log('Score distribution:');
            Object.entries(distribution).forEach(([range, count]) => {
                log(`  ${range}: ${count} students`);
            });
            
            showStatus(`‚úÖ Analytics calculations complete! ${totalAttempts} attempts, ${averageScore}% average`, 'success');
            log('=== ANALYTICS CALCULATIONS COMPLETE ===');
        }
        
        function openQuizManagement() {
            log('Opening quiz management page...');
            window.open('pages/quiz-management.html', '_blank');
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('=== ANALYTICS DEBUG TOOL LOADED ===');
            log('Ready to test analytics functionality');
            
            // Quick status check
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const quizzes = JSON.parse(localStorage.getItem('gestureQuizzes') || '[]');
            const results = JSON.parse(localStorage.getItem('quizResults') || '[]');
            
            if (currentUser.email && quizzes.length > 0 && results.length > 0) {
                showStatus('‚úÖ Existing data detected. Ready for testing!', 'success');
            } else {
                showStatus('‚ÑπÔ∏è No test data detected. Run "Setup Test Data" to begin.', 'info');
            }
        });
    </script>
</body>
</html>

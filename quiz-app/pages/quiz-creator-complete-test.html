<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Creator Test - GestureQuiz</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn {
            background: #0284c7;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover {
            background: #0369a1;
        }
        .btn-outline {
            background: transparent;
            color: #0284c7;
            border: 2px solid #0284c7;
        }
        .btn-outline:hover {
            background: #0284c7;
            color: white;
        }
        .btn-success {
            background: #22c55e;
        }
        .btn-success:hover {
            background: #16a34a;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
            font-size: 12px;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-input, .form-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin: 5px 0;
        }
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .question-container {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            background: #fafafa;
        }
        .option-row {
            display: flex;
            gap: 10px;
            margin: 5px 0;
            align-items: center;
        }
        .option-row select {
            width: 80px;
        }
        .option-row input {
            flex: 1;
        }
        .correct-answer {
            margin: 10px 0;
        }
        .step-indicator {
            background: #e5e5e5;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        .step-indicator.active {
            background: #22c55e;
            color: white;
        }
        .step-indicator.error {
            background: #ef4444;
            color: white;
        }
    </style>
</head>
<body>
    <h1>üß™ Quiz Creator Complete Test</h1>
    
    <div class="test-section">
        <h2>Step-by-Step Quiz Creation Test</h2>
        <p>This will test the complete quiz creation and publish flow step by step.</p>
        
        <div id="step1" class="step-indicator active">Step 1: Fill Quiz Details</div>
        <div id="step2" class="step-indicator">Step 2: Add Questions</div>
        <div id="step3" class="step-indicator">Step 3: Submit Quiz</div>
        <div id="step4" class="step-indicator">Step 4: Publish Options</div>
        
        <form id="testQuizForm">
            <div class="form-group">
                <label class="form-label">Quiz Title:</label>
                <input type="text" class="form-input" id="quizTitle" name="quizTitle" value="Test Quiz for Publishing">
            </div>
            
            <div class="form-group">
                <label class="form-label">Quiz Description:</label>
                <input type="text" class="form-input" id="quizDescription" name="quizDescription" value="A test quiz to verify the publish functionality">
            </div>
            
            <div class="form-group">
                <label class="form-label">Category:</label>
                <select class="form-select" id="quizCategory" name="quizCategory">
                    <option value="science">Science</option>
                    <option value="math">Math</option>
                    <option value="history">History</option>
                    <option value="technology" selected>Technology</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Difficulty:</label>
                <select class="form-select" id="quizDifficulty" name="quizDifficulty">
                    <option value="easy" selected>Easy</option>
                    <option value="medium">Medium</option>
                    <option value="hard">Hard</option>
                </select>
            </div>
            
            <button type="button" class="btn" onclick="completeStep1()">‚úÖ Complete Quiz Details</button>
        </form>
        
        <div id="questionsSection" style="display: none;">
            <h3>Questions Section</h3>
            <div id="questionsContainer"></div>
            <button type="button" class="btn btn-outline" onclick="addTestQuestion()">‚ûï Add Test Question</button>
            <button type="button" class="btn btn-success" onclick="completeStep2()" disabled id="completeQuestionsBtn">‚úÖ Complete Questions</button>
        </div>
        
        <div id="submitSection" style="display: none;">
            <h3>Submit Quiz</h3>
            <button type="button" class="btn btn-success" onclick="submitTestQuiz()">üöÄ Submit Quiz for Publishing</button>
        </div>
        
        <div class="log" id="debugLog">Debug log will appear here...</div>
        
        <div style="margin-top: 20px;">
            <button class="btn btn-outline" onclick="clearLog()">Clear Log</button>
            <button class="btn btn-outline" onclick="resetTest()">Reset Test</button>
            <button class="btn" onclick="testDirectPublish()">üß™ Test Direct Publish Modal</button>
        </div>
    </div>
    
    <script>
        let questionCount = 0;
        let debugLog = document.getElementById('debugLog');
        let currentStep = 1;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            debugLog.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            debugLog.textContent = '';
        }
        
        function updateStepIndicator(step, status = 'active') {
            // Reset all steps
            for (let i = 1; i <= 4; i++) {
                const element = document.getElementById(`step${i}`);
                element.className = 'step-indicator';
                if (i < step) {
                    element.className += ' success';
                    element.style.background = '#22c55e';
                    element.style.color = 'white';
                } else if (i === step) {
                    element.className += ` ${status}`;
                    if (status === 'error') {
                        element.style.background = '#ef4444';
                        element.style.color = 'white';
                    } else {
                        element.style.background = '#0284c7';
                        element.style.color = 'white';
                    }
                }
            }
        }
        
        function completeStep1() {
            log('Step 1: Validating quiz details...');
            
            const title = document.getElementById('quizTitle').value.trim();
            const description = document.getElementById('quizDescription').value.trim();
            const category = document.getElementById('quizCategory').value;
            const difficulty = document.getElementById('quizDifficulty').value;
            
            if (!title || !description) {
                log('ERROR: Quiz title and description are required', 'error');
                updateStepIndicator(1, 'error');
                return;
            }
            
            log(`Quiz details completed: ${title} (${category}, ${difficulty})`, 'success');
            updateStepIndicator(2);
            currentStep = 2;
            
            document.getElementById('questionsSection').style.display = 'block';
        }
        
        function addTestQuestion() {
            questionCount++;
            log(`Adding test question ${questionCount}`);
            
            const container = document.getElementById('questionsContainer');
            const questionDiv = document.createElement('div');
            questionDiv.className = 'question-container question-item';
            questionDiv.dataset.question = questionCount;
            
            questionDiv.innerHTML = `
                <h4>Question ${questionCount}</h4>
                <div class="form-group">
                    <label class="form-label">Question Text:</label>
                    <input type="text" class="form-input" name="question_${questionCount}" value="What gesture represents approval?">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Answer Options:</label>
                    <div class="option-row">
                        <select name="gesture_${questionCount}_1">
                            <option value="üëç">üëç</option>
                            <option value="‚úåÔ∏è">‚úåÔ∏è</option>
                            <option value="üëå">üëå</option>
                            <option value="‚úã">‚úã</option>
                        </select>
                        <input type="text" name="option_${questionCount}_1" value="Thumbs up" placeholder="Option A">
                    </div>
                    <div class="option-row">
                        <select name="gesture_${questionCount}_2">
                            <option value="üëç">üëç</option>
                            <option value="‚úåÔ∏è" selected>‚úåÔ∏è</option>
                            <option value="üëå">üëå</option>
                            <option value="‚úã">‚úã</option>
                        </select>
                        <input type="text" name="option_${questionCount}_2" value="Peace sign" placeholder="Option B">
                    </div>
                    <div class="option-row">
                        <select name="gesture_${questionCount}_3">
                            <option value="üëç">üëç</option>
                            <option value="‚úåÔ∏è">‚úåÔ∏è</option>
                            <option value="üëå" selected>üëå</option>
                            <option value="‚úã">‚úã</option>
                        </select>
                        <input type="text" name="option_${questionCount}_3" value="OK sign" placeholder="Option C">
                    </div>
                    <div class="option-row">
                        <select name="gesture_${questionCount}_4">
                            <option value="üëç">üëç</option>
                            <option value="‚úåÔ∏è">‚úåÔ∏è</option>
                            <option value="üëå">üëå</option>
                            <option value="‚úã" selected>‚úã</option>
                        </select>
                        <input type="text" name="option_${questionCount}_4" value="Stop hand" placeholder="Option D">
                    </div>
                </div>
                
                <div class="correct-answer">
                    <label class="form-label">Correct Answer:</label>
                    <select name="correct_${questionCount}">
                        <option value="1" selected>Option A (Thumbs up)</option>
                        <option value="2">Option B (Peace sign)</option>
                        <option value="3">Option C (OK sign)</option>
                        <option value="4">Option D (Stop hand)</option>
                    </select>
                </div>
                
                <button type="button" class="btn btn-outline" onclick="removeQuestion(${questionCount})">üóëÔ∏è Remove Question</button>
                <hr>
            `;
            
            container.appendChild(questionDiv);
            log(`Test question ${questionCount} added successfully`, 'success');
            
            // Enable complete questions button
            document.getElementById('completeQuestionsBtn').disabled = false;
        }
        
        function removeQuestion(num) {
            const questionDiv = document.querySelector(`[data-question="${num}"]`);
            if (questionDiv) {
                questionDiv.remove();
                log(`Question ${num} removed`);
                
                // Check if we still have questions
                const remainingQuestions = document.querySelectorAll('.question-item');
                if (remainingQuestions.length === 0) {
                    document.getElementById('completeQuestionsBtn').disabled = true;
                }
            }
        }
        
        function completeStep2() {
            log('Step 2: Validating questions...');
            
            const questionItems = document.querySelectorAll('.question-item');
            if (questionItems.length === 0) {
                log('ERROR: At least one question is required', 'error');
                updateStepIndicator(2, 'error');
                return;
            }
            
            // Validate each question
            let allValid = true;
            questionItems.forEach((item, index) => {
                const questionNum = item.dataset.question;
                const questionText = document.querySelector(`[name="question_${questionNum}"]`).value.trim();
                const options = [
                    document.querySelector(`[name="option_${questionNum}_1"]`).value.trim(),
                    document.querySelector(`[name="option_${questionNum}_2"]`).value.trim(),
                    document.querySelector(`[name="option_${questionNum}_3"]`).value.trim(),
                    document.querySelector(`[name="option_${questionNum}_4"]`).value.trim()
                ];
                
                if (!questionText) {
                    log(`ERROR: Question ${questionNum} text is empty`, 'error');
                    allValid = false;
                }
                
                const emptyOptions = options.filter(opt => !opt);
                if (emptyOptions.length > 0) {
                    log(`ERROR: Question ${questionNum} has empty options`, 'error');
                    allValid = false;
                }
            });
            
            if (!allValid) {
                updateStepIndicator(2, 'error');
                return;
            }
            
            log(`Questions completed: ${questionItems.length} questions validated`, 'success');
            updateStepIndicator(3);
            currentStep = 3;
            
            document.getElementById('submitSection').style.display = 'block';
        }
        
        function submitTestQuiz() {
            log('Step 3: Submitting quiz for publishing...');
            
            try {
                // Simulate the exact same process as the real quiz creator
                const quizData = {
                    id: 'quiz_test_' + Date.now(),
                    title: document.getElementById('quizTitle').value.trim(),
                    description: document.getElementById('quizDescription').value.trim(),
                    category: document.getElementById('quizCategory').value,
                    difficulty: document.getElementById('quizDifficulty').value,
                    questions: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    createdBy: 'ahmadadeltub@gmail.com', // Use our test teacher
                    status: 'draft',
                    published: false
                };
                
                log('Quiz data structure created');
                
                // Collect questions
                const questionItems = document.querySelectorAll('.question-item');
                log(`Processing ${questionItems.length} questions`);
                
                questionItems.forEach((item, index) => {
                    const questionNum = item.dataset.question;
                    const question = {
                        id: questionNum,
                        text: document.querySelector(`[name="question_${questionNum}"]`).value,
                        options: [
                            {
                                text: document.querySelector(`[name="option_${questionNum}_1"]`).value,
                                gesture: document.querySelector(`[name="gesture_${questionNum}_1"]`).value
                            },
                            {
                                text: document.querySelector(`[name="option_${questionNum}_2"]`).value,
                                gesture: document.querySelector(`[name="gesture_${questionNum}_2"]`).value
                            },
                            {
                                text: document.querySelector(`[name="option_${questionNum}_3"]`).value,
                                gesture: document.querySelector(`[name="gesture_${questionNum}_3"]`).value
                            },
                            {
                                text: document.querySelector(`[name="option_${questionNum}_4"]`).value,
                                gesture: document.querySelector(`[name="gesture_${questionNum}_4"]`).value
                            }
                        ],
                        correctAnswer: parseInt(document.querySelector(`[name="correct_${questionNum}"]`).value) - 1
                    };
                    
                    quizData.questions.push(question);
                    log(`Question ${questionNum} processed: ${question.text}`);
                });
                
                log('All questions processed successfully');
                log('Final quiz data: ' + JSON.stringify(quizData, null, 2));
                
                // Now test the save/publish modal
                updateStepIndicator(4);
                currentStep = 4;
                
                log('Step 4: Showing save/publish modal...');
                showTestSavePublishModal(quizData);
                
            } catch (error) {
                log('ERROR in submitTestQuiz: ' + error.message, 'error');
                updateStepIndicator(3, 'error');
            }
        }
        
        function showTestSavePublishModal(quizData) {
            log('Showing save/publish modal');
            
            // Store quiz data globally
            window.testQuizData = quizData;
            
            // Remove existing modal if any
            const existingModal = document.querySelector('.modal-overlay');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div class="modal-content" style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
                    <div class="modal-header">
                        <h3>üìù Quiz Ready to Save</h3>
                        <button class="close-btn" onclick="closeTestModal()" style="float: right; background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="save-publish-info">
                            <h4>${quizData.title}</h4>
                            <p>Your quiz is ready! Choose how you'd like to proceed:</p>
                        </div>
                        <div class="save-publish-actions" style="margin-top: 20px;">
                            <button class="btn btn-outline" onclick="testSaveAsDraft()">
                                üíæ Save as Draft
                            </button>
                            <button class="btn btn-success" onclick="testPublishQuiz()">
                                üöÄ Publish
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            log('Save/Publish modal displayed successfully', 'success');
            
            // Add click outside to close
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeTestModal();
                }
            });
        }
        
        function closeTestModal() {
            const modal = document.querySelector('.modal-overlay');
            if (modal) {
                modal.remove();
                log('Modal closed');
            }
        }
        
        function testSaveAsDraft() {
            log('Testing save as draft...');
            const quizData = window.testQuizData;
            
            if (!quizData) {
                log('ERROR: No quiz data found', 'error');
                return;
            }
            
            quizData.status = 'draft';
            quizData.published = false;
            
            const quizzes = JSON.parse(localStorage.getItem('gestureQuizzes') || '[]');
            quizzes.push(quizData);
            localStorage.setItem('gestureQuizzes', JSON.stringify(quizzes));
            
            log('Quiz saved as draft successfully!', 'success');
            closeTestModal();
            alert('‚úÖ Quiz saved as draft! Check localStorage or go to quiz management.');
        }
        
        function testPublishQuiz() {
            log('Testing publish quiz flow...');
            const quizData = window.testQuizData;
            
            if (!quizData) {
                log('ERROR: No quiz data found', 'error');
                return;
            }
            
            closeTestModal();
            showTestPublishOptions(quizData);
        }
        
        function showTestPublishOptions(quizData) {
            log('Showing publish options modal');
            
            window.testPublishQuizData = quizData;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div class="modal-content" style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
                    <div class="modal-header">
                        <h3>üìÖ Publish Quiz</h3>
                        <button class="close-btn" onclick="closeTestModal()" style="float: right; background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    <div class="modal-body">
                        <h4>When would you like to publish this quiz?</h4>
                        
                        <div style="margin: 15px 0;">
                            <input type="radio" id="publishNow" name="publishTime" value="now" checked>
                            <label for="publishNow">
                                <strong>Publish Now</strong><br>
                                <span>Make the quiz available to students immediately</span>
                            </label>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <input type="radio" id="publishLater" name="publishTime" value="later">
                            <label for="publishLater">
                                <strong>Schedule for Later</strong><br>
                                <span>Set a specific date and time to publish</span>
                            </label>
                        </div>
                        
                        <div class="schedule-datetime" id="scheduleDateTime" style="display: none; margin: 15px 0;">
                            <label for="publishDate">Date:</label>
                            <input type="date" id="publishDate" min="${new Date().toISOString().split('T')[0]}" style="margin: 5px;">
                            <br>
                            <label for="publishTime">Time:</label>
                            <input type="time" id="publishTime" value="09:00" style="margin: 5px;">
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <button class="btn btn-outline" onclick="closeTestModal()">Cancel</button>
                            <button class="btn btn-success" onclick="testConfirmPublish()">
                                üöÄ Publish Quiz
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            log('Publish options modal displayed', 'success');
            
            // Add event listeners
            document.getElementById('publishNow').addEventListener('change', function() {
                document.getElementById('scheduleDateTime').style.display = 'none';
            });
            
            document.getElementById('publishLater').addEventListener('change', function() {
                document.getElementById('scheduleDateTime').style.display = 'block';
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                document.getElementById('publishDate').value = tomorrow.toISOString().split('T')[0];
            });
        }
        
        function testConfirmPublish() {
            log('Testing confirm publish...');
            const quizData = window.testPublishQuizData;
            
            if (!quizData) {
                log('ERROR: No quiz data found for publishing', 'error');
                return;
            }
            
            const publishTimeOption = document.querySelector('input[name="publishTime"]:checked').value;
            log('Publish option selected: ' + publishTimeOption);
            
            if (publishTimeOption === 'now') {
                quizData.status = 'published';
                quizData.published = true;
                quizData.publishedAt = new Date().toISOString();
                
                const quizzes = JSON.parse(localStorage.getItem('gestureQuizzes') || '[]');
                quizzes.push(quizData);
                localStorage.setItem('gestureQuizzes', JSON.stringify(quizzes));
                
                log('Quiz published successfully!', 'success');
                closeTestModal();
                alert('üéâ Quiz published successfully! Students can now access it.');
            } else {
                const publishDate = document.getElementById('publishDate').value;
                const publishTime = document.getElementById('publishTime').value;
                
                if (!publishDate || !publishTime) {
                    log('ERROR: Date and time required for scheduling', 'error');
                    alert('Please select both date and time for scheduling.');
                    return;
                }
                
                const publishDateTime = new Date(`${publishDate}T${publishTime}`);
                
                if (publishDateTime <= new Date()) {
                    log('ERROR: Future date required', 'error');
                    alert('Please select a future date and time.');
                    return;
                }
                
                quizData.status = 'scheduled';
                quizData.published = false;
                quizData.scheduledPublishAt = publishDateTime.toISOString();
                
                const quizzes = JSON.parse(localStorage.getItem('gestureQuizzes') || '[]');
                quizzes.push(quizData);
                localStorage.setItem('gestureQuizzes', JSON.stringify(quizzes));
                
                log('Quiz scheduled successfully!', 'success');
                closeTestModal();
                
                const scheduleMessage = `Quiz scheduled to publish on ${publishDateTime.toLocaleDateString()} at ${publishDateTime.toLocaleTimeString()}`;
                alert(`üìÖ ${scheduleMessage}`);
            }
        }
        
        function testDirectPublish() {
            log('Testing direct publish modal...');
            const testData = {
                id: 'direct_test_' + Date.now(),
                title: 'Direct Test Quiz',
                description: 'Testing publish modal directly',
                category: 'test',
                difficulty: 'easy',
                questions: [{
                    id: '1',
                    text: 'Test question?',
                    options: [
                        { text: 'A', gesture: 'üëç' },
                        { text: 'B', gesture: '‚úåÔ∏è' },
                        { text: 'C', gesture: 'üëå' },
                        { text: 'D', gesture: '‚úã' }
                    ],
                    correctAnswer: 0
                }]
            };
            
            showTestSavePublishModal(testData);
        }
        
        function resetTest() {
            currentStep = 1;
            questionCount = 0;
            updateStepIndicator(1);
            
            document.getElementById('questionsSection').style.display = 'none';
            document.getElementById('submitSection').style.display = 'none';
            document.getElementById('questionsContainer').innerHTML = '';
            document.getElementById('completeQuestionsBtn').disabled = true;
            
            // Reset form
            document.getElementById('quizTitle').value = 'Test Quiz for Publishing';
            document.getElementById('quizDescription').value = 'A test quiz to verify the publish functionality';
            
            log('Test reset to beginning', 'info');
        }
        
        // Initialize
        log('Quiz Creator Test Page loaded');
        log('Follow the steps to test the complete publish flow');
        updateStepIndicator(1);
    </script>
</body>
</html>

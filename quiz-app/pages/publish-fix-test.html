<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Management Fix Test - GestureQuiz</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .test-btn { background: #0284c7; color: white; border: none; padding: 12px 24px; margin: 10px; border-radius: 6px; cursor: pointer; }
        .test-btn:hover { background: #0369a1; }
        .results { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .success { color: #22c55e; font-weight: bold; }
        .error { color: #ef4444; font-weight: bold; }
        .info { color: #0284c7; }
    </style>
</head>
<body>
    <h1>üîß Quiz Management Publish Fix Test</h1>
    <p>This page tests the "Quiz not found!" error fix for the quiz management system.</p>
    
    <div class="actions">
        <button class="test-btn" onclick="setupTestQuiz()">1. Setup Test Quiz</button>
        <button class="test-btn" onclick="testPublishFlow()">2. Test Publish Flow</button>
        <button class="test-btn" onclick="clearTestData()">3. Clear Test Data</button>
        <button class="test-btn" onclick="goToManagement()">Go to Quiz Management</button>
    </div>

    <div id="results" class="results" style="display:none;"></div>

    <h3>Test Steps:</h3>
    <ol>
        <li><strong>Setup Test Quiz</strong> - Creates a quiz with the new ID format</li>
        <li><strong>Test Publish Flow</strong> - Simulates the publish process that was failing</li>
        <li><strong>Check Results</strong> - Verifies the fix works correctly</li>
    </ol>

    <h3>Fix Details:</h3>
    <ul>
        <li>‚úÖ Changed quiz IDs from numbers to strings (e.g., "quiz_1720123456789")</li>
        <li>‚úÖ Added type-safe ID matching in publish/edit/delete functions</li>
        <li>‚úÖ Improved button click handlers to use data attributes</li>
        <li>‚úÖ Added debug logging to identify future issues</li>
    </ul>

    <script>
        let testQuizId = null;

        function setupTestQuiz() {
            // Ensure we have a current user
            const currentUser = {
                email: 'teacher@test.com',
                name: 'Test Teacher',
                role: 'teacher'
            };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            // Create a test quiz with the new ID format
            const testQuiz = {
                id: 'quiz_' + Date.now(),
                title: 'Test Quiz for Publish Fix',
                description: 'This quiz tests the publish functionality fix',
                category: 'Technology',
                difficulty: 'easy',
                status: 'draft',
                published: false,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                createdBy: currentUser.email,
                questions: [
                    {
                        id: 1,
                        text: 'What is 2 + 2?',
                        options: [
                            { text: '3', gesture: 'swipe-left' },
                            { text: '4', gesture: 'swipe-right' },
                            { text: '5', gesture: 'swipe-up' },
                            { text: '6', gesture: 'swipe-down' }
                        ],
                        correctAnswer: 1,
                        points: 10
                    }
                ]
            };

            testQuizId = testQuiz.id;

            // Add to localStorage
            const quizzes = JSON.parse(localStorage.getItem('gestureQuizzes') || '[]');
            quizzes.push(testQuiz);
            localStorage.setItem('gestureQuizzes', JSON.stringify(quizzes));

            showResults(`‚úÖ Test quiz created successfully!<br>
                         <span class="info">Quiz ID: ${testQuiz.id}</span><br>
                         <span class="info">ID Type: ${typeof testQuiz.id}</span>`, 'success');
        }

        function testPublishFlow() {
            if (!testQuizId) {
                showResults('‚ùå Please setup test quiz first!', 'error');
                return;
            }

            // Simulate the publish flow that was failing
            const quizzes = JSON.parse(localStorage.getItem('gestureQuizzes') || '[]');
            
            // Test the old way (that was failing)
            let quizIndex = quizzes.findIndex(q => q.id === testQuizId);
            let oldWayResult = quizIndex !== -1 ? 'Found' : 'Not Found';
            
            // Test the new way (with type-safe matching)
            if (quizIndex === -1) {
                quizIndex = quizzes.findIndex(q => String(q.id) === String(testQuizId));
            }
            if (quizIndex === -1) {
                quizIndex = quizzes.findIndex(q => Number(q.id) === Number(testQuizId));
            }
            let newWayResult = quizIndex !== -1 ? 'Found' : 'Not Found';

            if (quizIndex !== -1) {
                // Simulate publishing
                quizzes[quizIndex].status = 'published';
                quizzes[quizIndex].published = true;
                quizzes[quizIndex].publishedAt = new Date().toISOString();
                localStorage.setItem('gestureQuizzes', JSON.stringify(quizzes));

                showResults(`üéâ Publish test successful!<br>
                             <span class="info">Old method result: ${oldWayResult}</span><br>
                             <span class="info">New method result: ${newWayResult}</span><br>
                             <span class="success">Quiz published successfully!</span>`, 'success');
            } else {
                showResults(`‚ùå Publish test failed!<br>
                             <span class="error">Could not find quiz with ID: ${testQuizId}</span>`, 'error');
            }
        }

        function clearTestData() {
            localStorage.removeItem('gestureQuizzes');
            localStorage.removeItem('currentUser');
            testQuizId = null;
            showResults('üóëÔ∏è Test data cleared!', 'info');
        }

        function showResults(message, type) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<div class="${type}">${message}</div>`;
            resultsDiv.style.display = 'block';
        }

        function goToManagement() {
            window.location.href = 'quiz-management.html';
        }

        // Auto-check localStorage on page load
        document.addEventListener('DOMContentLoaded', function() {
            const quizzes = JSON.parse(localStorage.getItem('gestureQuizzes') || '[]');
            const user = JSON.parse(localStorage.getItem('currentUser') || '{}');
            
            if (quizzes.length > 0 || user.email) {
                showResults(`‚ÑπÔ∏è Found existing data:<br>
                             <span class="info">Quizzes: ${quizzes.length}</span><br>
                             <span class="info">Current user: ${user.email || 'None'}</span>`, 'info');
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Storage Demo - GestureQuiz</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            --success-500: #10b981;
            --danger-500: #ef4444;
            --warning-500: #f59e0b;
            --neutral-100: #f5f5f5;
            --neutral-200: #e5e5e5;
            --neutral-600: #525252;
            --neutral-800: #262626;
            --neutral-900: #171717;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--neutral-800);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .demo-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .demo-card h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--primary-600);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--neutral-700);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--neutral-200);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-600);
        }

        .btn {
            background: var(--primary-600);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--primary-700);
        }

        .btn:disabled {
            background: var(--neutral-200);
            cursor: not-allowed;
        }

        .btn-danger {
            background: var(--danger-500);
        }

        .btn-success {
            background: var(--success-500);
        }

        .file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--neutral-200);
            border-radius: 0.5rem;
            padding: 1rem;
            background: var(--neutral-100);
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            border-bottom: 1px solid var(--neutral-200);
            background: white;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .file-item:last-child {
            margin-bottom: 0;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .file-icon {
            font-size: 1.5rem;
            color: var(--primary-600);
        }

        .file-details h4 {
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .file-details p {
            font-size: 0.8rem;
            color: var(--neutral-600);
        }

        .file-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }

        .status {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .status.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .status.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--neutral-200);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--success-500);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 0.5rem;
            margin: 1rem 0;
            object-fit: cover;
        }

        .auth-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(10px);
            color: white;
        }

        .auth-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .auth-status.signed-in {
            color: #10b981;
        }

        .auth-status.signed-out {
            color: #ef4444;
        }

        @media (max-width: 768px) {
            .demo-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-cloud-upload-alt"></i> Firebase Storage Demo</h1>
            <p>Test file uploads, downloads, and management with Firebase Storage</p>
        </div>

        <!-- Authentication Status -->
        <div class="auth-section">
            <div class="auth-status" id="authStatus">
                <i class="fas fa-user-slash"></i>
                <span>Not authenticated</span>
            </div>
            <div id="authControls">
                <button class="btn" onclick="signInTestUser()">
                    <i class="fas fa-sign-in-alt"></i>
                    Sign In as Test User
                </button>
                <button class="btn btn-danger" onclick="signOut()" style="display: none;" id="signOutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Sign Out
                </button>
            </div>
        </div>

        <div class="demo-grid">
            <!-- Profile Image Upload -->
            <div class="demo-card">
                <h3><i class="fas fa-user-circle"></i> Profile Image Upload</h3>
                <div class="form-group">
                    <label for="profileImage">Choose Profile Image</label>
                    <input type="file" id="profileImage" class="form-control" accept="image/*">
                </div>
                <button class="btn" onclick="uploadProfileImage()" id="uploadProfileBtn">
                    <i class="fas fa-upload"></i>
                    Upload Profile Image
                </button>
                <div class="progress-bar" id="profileProgress" style="display: none;">
                    <div class="progress-fill" id="profileProgressFill"></div>
                </div>
                <div id="profileStatus"></div>
                <div id="profilePreview"></div>
            </div>

            <!-- Quiz Asset Upload -->
            <div class="demo-card">
                <h3><i class="fas fa-file-upload"></i> Quiz Asset Upload</h3>
                <div class="form-group">
                    <label for="quizId">Quiz ID</label>
                    <input type="text" id="quizId" class="form-control" placeholder="Enter quiz ID" value="demo-quiz-123">
                </div>
                <div class="form-group">
                    <label for="quizAsset">Choose Asset File</label>
                    <input type="file" id="quizAsset" class="form-control">
                </div>
                <button class="btn" onclick="uploadQuizAsset()" id="uploadAssetBtn">
                    <i class="fas fa-upload"></i>
                    Upload Quiz Asset
                </button>
                <div class="progress-bar" id="assetProgress" style="display: none;">
                    <div class="progress-fill" id="assetProgressFill"></div>
                </div>
                <div id="assetStatus"></div>
            </div>

            <!-- File Management -->
            <div class="demo-card">
                <h3><i class="fas fa-folder-open"></i> File Management</h3>
                <div style="margin-bottom: 1rem;">
                    <button class="btn" onclick="listUserFiles()">
                        <i class="fas fa-list"></i>
                        List My Files
                    </button>
                    <button class="btn btn-success" onclick="listQuizAssets()">
                        <i class="fas fa-images"></i>
                        List Quiz Assets
                    </button>
                </div>
                <div id="fileListContainer">
                    <div class="file-list" id="fileList">
                        <p style="text-align: center; color: var(--neutral-600);">
                            Click "List My Files" to see your uploaded files
                        </p>
                    </div>
                </div>
            </div>

            <!-- Storage Stats -->
            <div class="demo-card">
                <h3><i class="fas fa-chart-bar"></i> Storage Information</h3>
                <div id="storageStats">
                    <div class="status info">
                        <strong>Storage Bucket:</strong> gs://gesturequiz-platform-429dd.firebasestorage.app
                    </div>
                    <div class="status info">
                        <strong>Features Available:</strong>
                        <ul style="margin-top: 0.5rem; margin-left: 1rem;">
                            <li>Profile image uploads</li>
                            <li>Quiz asset management</li>
                            <li>File listing and deletion</li>
                            <li>Download URL generation</li>
                            <li>File validation</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="js/firebase-data-manager.js"></script>
    <script>
        let currentUser = null;
        let dataManager = null;

        // Initialize Firebase
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Wait for Firebase to initialize
                if (window.firebaseDataManager) {
                    dataManager = window.firebaseDataManager;
                    
                    // Wait for initialization
                    let initAttempts = 0;
                    while (!dataManager.isInitialized && initAttempts < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        initAttempts++;
                    }
                    
                    if (dataManager.isInitialized) {
                        showStatus('Firebase initialized successfully!', 'success');
                        checkAuthState();
                    } else {
                        showStatus('Firebase initialization timeout', 'error');
                    }
                } else {
                    showStatus('Firebase data manager not found', 'error');
                }
            } catch (error) {
                console.error('Demo initialization error:', error);
                showStatus('Demo initialization failed: ' + error.message, 'error');
            }
        });

        function checkAuthState() {
            currentUser = dataManager.getCurrentUser();
            updateAuthUI();
        }

        function updateAuthUI() {
            const authStatus = document.getElementById('authStatus');
            const signOutBtn = document.getElementById('signOutBtn');
            
            if (currentUser) {
                authStatus.innerHTML = `
                    <i class="fas fa-user-check"></i>
                    <span>Signed in as: ${currentUser.email || 'Unknown'}</span>
                `;
                authStatus.className = 'auth-status signed-in';
                signOutBtn.style.display = 'inline-flex';
            } else {
                authStatus.innerHTML = `
                    <i class="fas fa-user-slash"></i>
                    <span>Not authenticated</span>
                `;
                authStatus.className = 'auth-status signed-out';
                signOutBtn.style.display = 'none';
            }
        }

        async function signInTestUser() {
            try {
                showStatus('Signing in test user...', 'info');
                
                const result = await dataManager.signIn('teacher@gesturequiz.com', 'password123');
                
                if (result.success) {
                    currentUser = dataManager.getCurrentUser();
                    updateAuthUI();
                    showStatus('Signed in successfully!', 'success');
                } else {
                    showStatus('Sign in failed: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Sign in error:', error);
                showStatus('Sign in error: ' + error.message, 'error');
            }
        }

        async function signOut() {
            try {
                await dataManager.signOut();
                currentUser = null;
                updateAuthUI();
                showStatus('Signed out successfully', 'success');
                
                // Clear file lists
                document.getElementById('fileList').innerHTML = `
                    <p style="text-align: center; color: var(--neutral-600);">
                        Sign in to see your files
                    </p>
                `;
            } catch (error) {
                console.error('Sign out error:', error);
                showStatus('Sign out error: ' + error.message, 'error');
            }
        }

        async function uploadProfileImage() {
            if (!currentUser) {
                showStatus('Please sign in first', 'error');
                return;
            }

            const fileInput = document.getElementById('profileImage');
            const file = fileInput.files[0];
            
            if (!file) {
                showStatus('Please select a file first', 'error');
                return;
            }

            // Validate file type
            const typeValidation = dataManager.validateFileType(file, ['image']);
            if (!typeValidation.valid) {
                showStatus(typeValidation.error, 'error');
                return;
            }

            // Validate file size (5MB limit for profile images)
            const sizeValidation = dataManager.validateFileSize(file, 5);
            if (!sizeValidation.valid) {
                showStatus(sizeValidation.error, 'error');
                return;
            }

            try {
                const btn = document.getElementById('uploadProfileBtn');
                const progress = document.getElementById('profileProgress');
                const progressFill = document.getElementById('profileProgressFill');
                
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                progress.style.display = 'block';
                progressFill.style.width = '50%';

                const result = await dataManager.uploadProfileImage(file);
                
                if (result.success) {
                    progressFill.style.width = '100%';
                    showProfileStatus('Profile image uploaded successfully!', 'success');
                    
                    // Show preview
                    const preview = document.getElementById('profilePreview');
                    preview.innerHTML = `
                        <img src="${result.downloadURL}" alt="Profile Preview" class="image-preview">
                        <p><strong>Download URL:</strong> <a href="${result.downloadURL}" target="_blank">View Image</a></p>
                    `;
                } else {
                    showProfileStatus('Upload failed: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showProfileStatus('Upload error: ' + error.message, 'error');
            } finally {
                const btn = document.getElementById('uploadProfileBtn');
                const progress = document.getElementById('profileProgress');
                
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-upload"></i> Upload Profile Image';
                setTimeout(() => {
                    progress.style.display = 'none';
                }, 1000);
            }
        }

        async function uploadQuizAsset() {
            if (!currentUser) {
                showStatus('Please sign in first', 'error');
                return;
            }

            const quizId = document.getElementById('quizId').value.trim();
            const fileInput = document.getElementById('quizAsset');
            const file = fileInput.files[0];
            
            if (!quizId) {
                showStatus('Please enter a quiz ID', 'error');
                return;
            }

            if (!file) {
                showStatus('Please select a file first', 'error');
                return;
            }

            // Validate file size (10MB limit for quiz assets)
            const sizeValidation = dataManager.validateFileSize(file, 10);
            if (!sizeValidation.valid) {
                showStatus(sizeValidation.error, 'error');
                return;
            }

            try {
                const btn = document.getElementById('uploadAssetBtn');
                const progress = document.getElementById('assetProgress');
                const progressFill = document.getElementById('assetProgressFill');
                
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                progress.style.display = 'block';
                progressFill.style.width = '50%';

                const result = await dataManager.uploadQuizAsset(quizId, file);
                
                if (result.success) {
                    progressFill.style.width = '100%';
                    showAssetStatus('Quiz asset uploaded successfully!', 'success');
                    
                    // Show file info
                    const status = document.getElementById('assetStatus');
                    status.innerHTML += `
                        <div class="status success" style="margin-top: 1rem;">
                            <strong>File Path:</strong> ${result.fullPath}<br>
                            <strong>Size:</strong> ${(result.size / 1024).toFixed(2)} KB<br>
                            <strong>Download URL:</strong> <a href="${result.downloadURL}" target="_blank">Open File</a>
                        </div>
                    `;
                } else {
                    showAssetStatus('Upload failed: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showAssetStatus('Upload error: ' + error.message, 'error');
            } finally {
                const btn = document.getElementById('uploadAssetBtn');
                const progress = document.getElementById('assetProgress');
                
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-upload"></i> Upload Quiz Asset';
                setTimeout(() => {
                    progress.style.display = 'none';
                }, 1000);
            }
        }

        async function listUserFiles() {
            if (!currentUser) {
                showStatus('Please sign in first', 'error');
                return;
            }

            try {
                showStatus('Loading user files...', 'info');
                
                const result = await dataManager.getUserFiles();
                
                if (result.success) {
                    displayFiles(result.files, 'user');
                    showStatus(`Found ${result.files.length} files`, 'success');
                } else {
                    showStatus('Failed to list files: ' + result.error, 'error');
                    document.getElementById('fileList').innerHTML = `
                        <p style="text-align: center; color: var(--neutral-600);">
                            No files found or error loading files
                        </p>
                    `;
                }
            } catch (error) {
                console.error('List files error:', error);
                showStatus('List files error: ' + error.message, 'error');
            }
        }

        async function listQuizAssets() {
            const quizId = document.getElementById('quizId').value.trim() || 'demo-quiz-123';
            
            try {
                showStatus('Loading quiz assets...', 'info');
                
                const result = await dataManager.getQuizAssets(quizId);
                
                if (result.success) {
                    displayFiles(result.files, 'quiz');
                    showStatus(`Found ${result.files.length} quiz assets`, 'success');
                } else {
                    showStatus('Failed to list quiz assets: ' + result.error, 'error');
                    document.getElementById('fileList').innerHTML = `
                        <p style="text-align: center; color: var(--neutral-600);">
                            No quiz assets found
                        </p>
                    `;
                }
            } catch (error) {
                console.error('List quiz assets error:', error);
                showStatus('List quiz assets error: ' + error.message, 'error');
            }
        }

        function displayFiles(files, type) {
            const fileList = document.getElementById('fileList');
            
            if (files.length === 0) {
                fileList.innerHTML = `
                    <p style="text-align: center; color: var(--neutral-600);">
                        No ${type} files found
                    </p>
                `;
                return;
            }

            fileList.innerHTML = files.map(file => {
                const isImage = file.name.match(/\.(jpg|jpeg|png|gif|webp)$/i);
                const icon = isImage ? 'fas fa-image' : 'fas fa-file';
                
                return `
                    <div class="file-item">
                        <div class="file-info">
                            <i class="${icon} file-icon"></i>
                            <div class="file-details">
                                <h4>${file.name}</h4>
                                <p>${file.fullPath}</p>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-small" onclick="openFile('${file.downloadURL}')">
                                <i class="fas fa-external-link-alt"></i>
                                Open
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deleteFile('${file.fullPath}')">
                                <i class="fas fa-trash"></i>
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function deleteFile(filePath) {
            if (!confirm(`Are you sure you want to delete this file?\n\n${filePath}`)) {
                return;
            }

            try {
                showStatus('Deleting file...', 'info');
                
                const result = await dataManager.deleteFile(filePath);
                
                if (result.success) {
                    showStatus('File deleted successfully', 'success');
                    // Refresh file list
                    listUserFiles();
                } else {
                    showStatus('Failed to delete file: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Delete file error:', error);
                showStatus('Delete file error: ' + error.message, 'error');
            }
        }

        function openFile(url) {
            window.open(url, '_blank');
        }

        function showStatus(message, type) {
            const status = document.createElement('div');
            status.className = `status ${type}`;
            status.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
            
            // Add to top of container
            const container = document.querySelector('.container');
            const header = document.querySelector('.header');
            container.insertBefore(status, header.nextSibling);
            
            // Remove after 5 seconds
            setTimeout(() => {
                status.remove();
            }, 5000);
        }

        function showProfileStatus(message, type) {
            const statusDiv = document.getElementById('profileStatus');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function showAssetStatus(message, type) {
            const statusDiv = document.getElementById('assetStatus');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rules Fix Test - GestureQuiz</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #dc2626;
            margin-bottom: 20px;
        }
        
        .urgent {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            margin: 10px 5px;
        }
        
        .btn.success {
            background: #059669;
        }
        
        .log {
            background: #1e293b;
            color: #f1f5f9;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        
        .rules-box {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        
        .copy-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® URGENT: Firebase Rules Fix</h1>
        
        <div class="urgent">
            <strong>ISSUE CONFIRMED:</strong> Your Firebase security rules are blocking access!<br>
            <strong>SOLUTION:</strong> Update rules in Firebase Console and click PUBLISH
        </div>
        
        <h3>üìã Step 1: Firestore Rules</h3>
        <p><strong>Go to:</strong> <a href="https://console.firebase.google.com/project/gesturequiz-platform-live/firestore/rules" target="_blank">Firestore Rules</a></p>
        <button class="copy-btn" onclick="copyRules('firestore')">COPY FIRESTORE RULES</button>
        <div class="rules-box" id="firestore-rules">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow authenticated users to access their own user document
    match /users/{userId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth != null && request.auth.uid == userId;
    }
    
    // Allow authenticated users to access classes
    match /classes/{classId} {
      allow read, write: if request.auth != null;
    }
    
    // Allow authenticated users to access quizzes
    match /quizzes/{quizId} {
      allow read, write: if request.auth != null;
    }
    
    // Allow authenticated users to access submissions
    match /submissions/{submissionId} {
      allow read, write: if request.auth != null;
    }
    
    // Allow test collections (for diagnostics)
    match /test/{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}</div>
        
        <h3>üíæ Step 2: Storage Rules</h3>
        <p><strong>Go to:</strong> <a href="https://console.firebase.google.com/project/gesturequiz-platform-live/storage/rules" target="_blank">Storage Rules</a></p>
        <button class="copy-btn" onclick="copyRules('storage')">COPY STORAGE RULES</button>
        <div class="rules-box" id="storage-rules">rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /{allPaths=**} {
      allow read, write: if request.auth != null;
    }
  }
}</div>
        
        <h3>üß™ Step 3: Test After Publishing</h3>
        <button class="btn success" onclick="testAfterFix()">‚úÖ Test Rules Fix</button>
        <button class="btn" onclick="window.open('login-fix-tool.html', '_blank')">üîß Back to Login Tool</button>
        
        <div class="log" id="logContainer">
            <div>[Ready] Rules fix test ready</div>
            <div>[Action] 1. Copy rules above</div>
            <div>[Action] 2. Paste in Firebase Console</div>
            <div>[Action] 3. Click PUBLISH for both</div>
            <div>[Action] 4. Test using button above</div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAt4ByDMxZFT00a-zESwNHS8uv3DY08uhg",
            authDomain: "gesturequiz-platform-live.firebaseapp.com",
            projectId: "gesturequiz-platform-live",
            storageBucket: "gesturequiz-platform-live.firebasestorage.app",
            messagingSenderId: "794242095954",
            appId: "1:794242095954:web:85868edc63c96d37ea388b",
            measurementId: "G-Y7WPTJRVG6"
        };

        let db, auth;

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();

        function copyRules(type) {
            const element = document.getElementById(type + '-rules');
            const textArea = document.createElement('textarea');
            textArea.value = element.textContent;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            log(`‚úÖ ${type} rules copied to clipboard!`);
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'COPIED!';
            btn.style.background = '#059669';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#dc2626';
            }, 2000);
        }

        async function testAfterFix() {
            log("üß™ TESTING RULES FIX...");
            
            try {
                // Test 1: Try to read users collection
                log("üîç Testing Firestore access...");
                
                // First login a user
                log("üîë Logging in test user...");
                await auth.signInWithEmailAndPassword("teacher@test.com", "teacher123");
                log("‚úÖ Login successful");
                
                // Test Firestore read
                const usersSnapshot = await db.collection('users').limit(1).get();
                log("‚úÖ Firestore read access: WORKING");
                
                // Test Firestore write
                const testDoc = db.collection('test').doc('rules-test');
                await testDoc.set({
                    message: 'Rules fix test',
                    timestamp: new Date().toISOString()
                });
                log("‚úÖ Firestore write access: WORKING");
                
                // Clean up
                await testDoc.delete();
                await auth.signOut();
                
                log("üéâ RULES FIX SUCCESSFUL!");
                log("‚úÖ All Firestore operations working");
                log("üîë You can now login normally!");
                
            } catch (error) {
                if (error.message.includes('permission')) {
                    log("‚ùå Rules still not updated");
                    log("üîß Make sure you clicked PUBLISH in Firebase Console");
                    log("‚è±Ô∏è Rules can take 1-2 minutes to propagate");
                } else if (error.code === 'auth/user-not-found') {
                    log("‚ÑπÔ∏è Test user not found - rules might be working");
                    log("üéØ Try creating users in the login tool");
                } else {
                    log("‚ùå Test failed: " + error.message);
                }
            }
        }

        function log(message) {
            const logContainer = document.getElementById('logContainer');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.textContent = `[${time}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
    </script>
</body>
</html>

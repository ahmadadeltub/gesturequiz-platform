<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Registration Debugger - GestureQuiz</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #dc3545;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .error-section {
            background: #f8d7da;
            border: 2px solid #dc3545;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #dc3545;
        }
        .solution-section {
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #28a745;
        }
        .debug-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid #ffc107;
        }
        .test-button {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .fix-button {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: all 0.3s ease;
        }
        .fix-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 15px 0;
            white-space: pre-wrap;
            position: relative;
        }
        .copy-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #4a5568;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .copy-button:hover {
            background: #2d3748;
        }
        .input-group {
            margin: 20px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        .nav-buttons {
            text-align: center;
            margin: 30px 0;
        }
        .nav-button {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            text-decoration: none;
            padding: 12px 24px;
            border-radius: 8px;
            margin: 0 10px;
            display: inline-block;
            transition: all 0.3s ease;
        }
        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .step-list {
            counter-reset: step-counter;
            list-style: none;
            padding: 0;
        }
        .step-list li {
            counter-increment: step-counter;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
            position: relative;
        }
        .step-list li::before {
            content: counter(step-counter);
            position: absolute;
            left: -15px;
            top: 20px;
            background: #dc3545;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß User Registration Debugger</h1>
        
        <div class="error-section">
            <h2>‚ùå Error Detected</h2>
            <div class="result error">
                <strong>Error Message:</strong> "Permission denied. Please check your internet connection and try again."
            </div>
            <p>This error occurs when:</p>
            <ul>
                <li>Firebase security rules are blocking user creation</li>
                <li>Firestore rules don't allow creating user documents</li>
                <li>Network connectivity issues</li>
                <li>Authentication configuration problems</li>
            </ul>
        </div>

        <div class="solution-section">
            <h2>üîß Quick Diagnosis</h2>
            <button class="test-button" onclick="runDiagnostic()">üîç Run Diagnostic</button>
            <button class="fix-button" onclick="testBasicAuth()">üîê Test Basic Auth</button>
            <button class="fix-button" onclick="checkFirestoreRules()">üóÑÔ∏è Check Firestore Rules</button>
            
            <div id="diagnostic-results"></div>
        </div>

        <div class="debug-section">
            <h2>üß™ Test User Registration</h2>
            <div class="input-group">
                <label for="test-email">Email:</label>
                <input type="email" id="test-email" placeholder="test@example.com" value="debug@gesturequiz.com">
            </div>
            <div class="input-group">
                <label for="test-password">Password:</label>
                <input type="password" id="test-password" placeholder="Password (min 6 chars)" value="debugpass123">
            </div>
            <div class="input-group">
                <label for="test-name">Name:</label>
                <input type="text" id="test-name" placeholder="Full Name" value="Debug User">
            </div>
            <div class="input-group">
                <label for="test-role">Role:</label>
                <select id="test-role">
                    <option value="teacher">Teacher</option>
                    <option value="student">Student</option>
                </select>
            </div>
            
            <button class="test-button" onclick="testUserRegistration()">üë§ Test Registration</button>
            <button class="fix-button" onclick="testAuthOnly()">üîê Test Auth Only</button>
            <button class="fix-button" onclick="testFirestoreOnly()">üóÑÔ∏è Test Firestore Only</button>
            
            <div id="test-results"></div>
        </div>

        <div class="solution-section">
            <h2>üîß Common Fixes</h2>
            <ol class="step-list">
                <li>
                    <strong>Check Internet Connection</strong>
                    <p>Ensure you have a stable internet connection and can access Firebase services.</p>
                    <button class="fix-button" onclick="testConnection()">üåê Test Connection</button>
                </li>
                
                <li>
                    <strong>Update Firestore Rules</strong>
                    <p>Make sure your Firestore rules allow user document creation:</p>
                    <div class="code-block">
                        <button class="copy-button" onclick="copyFirestoreRules()">üìã Copy</button>
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow users to create and manage their own documents
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
                    </div>
                    <a href="https://console.firebase.google.com/project/gesturequiz-platform-429dd/firestore/rules" target="_blank" class="fix-button">üîó Open Firestore Rules</a>
                </li>
                
                <li>
                    <strong>Check Firebase Configuration</strong>
                    <p>Verify that your Firebase configuration is correct:</p>
                    <button class="fix-button" onclick="checkFirebaseConfig()">üî• Check Config</button>
                </li>
                
                <li>
                    <strong>Test with Simple Rules</strong>
                    <p>For debugging, temporarily use these permissive rules:</p>
                    <div class="code-block">
                        <button class="copy-button" onclick="copyDebugRules()">üìã Copy</button>
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // DEBUG ONLY - Allow all authenticated users
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
                    </div>
                    <div class="result warning">
                        <strong>‚ö†Ô∏è WARNING:</strong> These are debug rules only. Replace with proper security rules before production!
                    </div>
                </li>
            </ol>
        </div>

        <div class="nav-buttons">
            <a href="firebase-rules-quick-fix.html" class="nav-button">üö® Rules Quick Fix</a>
            <a href="firebase-permissions-debugger.html" class="nav-button">üîß Permissions Debugger</a>
            <a href="register.html" class="nav-button">üìù Try Registration</a>
            <a href="testing-dashboard.html" class="nav-button">üéØ Testing Dashboard</a>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAMGOSAICQQbbduHDBvLzhcdImJkTrlTmc",
            authDomain: "gesturequiz-platform-429dd.firebaseapp.com",
            projectId: "gesturequiz-platform-429dd",
            storageBucket: "gesturequiz-platform-429dd.firebasestorage.app",
            messagingSenderId: "911639818705",
            appId: "1:911639818705:web:22d5bf2845c469185e70f0",
            measurementId: "G-Z8W4H5WDG7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        function addResult(message, type = 'info', containerId = 'diagnostic-results') {
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById(containerId).appendChild(resultDiv);
            
            // Scroll to bottom
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function copyFirestoreRules() {
            const rules = `rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow users to create and manage their own documents
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}`;
            navigator.clipboard.writeText(rules).then(() => {
                alert('‚úÖ Firestore rules copied!\nPaste into Firebase Console ‚Üí Firestore ‚Üí Rules');
            });
        }

        function copyDebugRules() {
            const rules = `rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // DEBUG ONLY - Allow all authenticated users
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}`;
            navigator.clipboard.writeText(rules).then(() => {
                alert('‚ö†Ô∏è DEBUG rules copied!\nREMEMBER: These are for testing only. Replace with proper security rules!');
            });
        }

        async function testConnection() {
            addResult('üåê Testing internet connection...', 'info');
            
            try {
                const response = await fetch('https://www.google.com', { mode: 'no-cors' });
                addResult('‚úÖ Internet connection is working', 'success');
            } catch (error) {
                addResult('‚ùå Internet connection failed', 'error');
                addResult(`Error: ${error.message}`, 'error');
            }

            try {
                const response = await fetch('https://firebase.googleapis.com/', { mode: 'no-cors' });
                addResult('‚úÖ Firebase services are accessible', 'success');
            } catch (error) {
                addResult('‚ùå Firebase services not accessible', 'error');
                addResult(`Error: ${error.message}`, 'error');
            }
        }

        async function checkFirebaseConfig() {
            addResult('üî• Checking Firebase configuration...', 'info');
            
            try {
                const app = firebase.app();
                addResult('‚úÖ Firebase app initialized successfully', 'success');
                addResult(`Project ID: ${app.options.projectId}`, 'success');
                addResult(`Auth Domain: ${app.options.authDomain}`, 'success');
                
                // Test auth service
                const currentUser = auth.currentUser;
                addResult(`Auth service accessible: ${currentUser ? 'Logged in' : 'Not logged in'}`, 'success');
                
                // Test Firestore service
                const testQuery = db.collection('users').limit(1);
                addResult('‚úÖ Firestore service accessible', 'success');
                
            } catch (error) {
                addResult(`‚ùå Firebase configuration error: ${error.message}`, 'error');
            }
        }

        async function testBasicAuth() {
            addResult('üîê Testing basic authentication...', 'info');
            
            try {
                // Try to create a user with Firebase Auth only
                const email = 'authtest@gesturequiz.com';
                const password = 'testpass123';
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                addResult('‚úÖ Firebase Authentication working', 'success');
                addResult(`User created: ${userCredential.user.email}`, 'success');
                
                // Clean up - delete the test user
                await userCredential.user.delete();
                addResult('üóëÔ∏è Test user cleaned up', 'success');
                
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    addResult('‚úÖ Firebase Authentication working (email already exists)', 'success');
                } else {
                    addResult(`‚ùå Authentication failed: ${error.message}`, 'error');
                    addResult(`Error code: ${error.code}`, 'error');
                }
            }
        }

        async function checkFirestoreRules() {
            addResult('üóÑÔ∏è Testing Firestore rules...', 'info');
            
            try {
                // First, check if user is authenticated
                const user = auth.currentUser;
                if (!user) {
                    addResult('‚ö†Ô∏è No user authenticated. Creating test user...', 'warning');
                    const userCredential = await auth.createUserWithEmailAndPassword('ruletest@gesturequiz.com', 'testpass123');
                    addResult('‚úÖ Test user created for rules testing', 'success');
                }
                
                const currentUser = auth.currentUser;
                
                // Test writing to Firestore
                const testDoc = db.collection('users').doc(currentUser.uid);
                await testDoc.set({
                    email: currentUser.email,
                    name: 'Rules Test User',
                    role: 'teacher',
                    createdAt: new Date().toISOString()
                });
                
                addResult('‚úÖ Firestore write successful', 'success');
                
                // Test reading from Firestore
                const doc = await testDoc.get();
                if (doc.exists) {
                    addResult('‚úÖ Firestore read successful', 'success');
                    addResult(`Document data: ${JSON.stringify(doc.data(), null, 2)}`, 'info');
                }
                
                // Clean up
                await testDoc.delete();
                await currentUser.delete();
                addResult('üóëÔ∏è Test data cleaned up', 'success');
                
            } catch (error) {
                addResult(`‚ùå Firestore rules test failed: ${error.message}`, 'error');
                addResult(`Error code: ${error.code}`, 'error');
                
                if (error.code === 'permission-denied') {
                    addResult('üîß Permission denied - check your Firestore rules!', 'warning');
                }
            }
        }

        async function testAuthOnly() {
            addResult('üîê Testing authentication only...', 'info', 'test-results');
            
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                addResult('‚úÖ Authentication successful', 'success', 'test-results');
                addResult(`User ID: ${userCredential.user.uid}`, 'success', 'test-results');
                addResult(`Email: ${userCredential.user.email}`, 'success', 'test-results');
                
                // Clean up
                await userCredential.user.delete();
                addResult('üóëÔ∏è Test user cleaned up', 'success', 'test-results');
                
            } catch (error) {
                addResult(`‚ùå Authentication failed: ${error.message}`, 'error', 'test-results');
                addResult(`Error code: ${error.code}`, 'error', 'test-results');
            }
        }

        async function testFirestoreOnly() {
            addResult('üóÑÔ∏è Testing Firestore only...', 'info', 'test-results');
            
            const user = auth.currentUser;
            if (!user) {
                addResult('‚ùå No user authenticated. Please test authentication first.', 'error', 'test-results');
                return;
            }
            
            const name = document.getElementById('test-name').value;
            const role = document.getElementById('test-role').value;
            
            try {
                const userDoc = db.collection('users').doc(user.uid);
                await userDoc.set({
                    email: user.email,
                    name: name,
                    role: role,
                    createdAt: new Date().toISOString(),
                    profilePicture: null
                });
                
                addResult('‚úÖ Firestore write successful', 'success', 'test-results');
                
                // Test reading
                const doc = await userDoc.get();
                if (doc.exists) {
                    addResult('‚úÖ Firestore read successful', 'success', 'test-results');
                    addResult(`User data: ${JSON.stringify(doc.data(), null, 2)}`, 'info', 'test-results');
                }
                
            } catch (error) {
                addResult(`‚ùå Firestore operation failed: ${error.message}`, 'error', 'test-results');
                addResult(`Error code: ${error.code}`, 'error', 'test-results');
            }
        }

        async function testUserRegistration() {
            addResult('üë§ Testing complete user registration...', 'info', 'test-results');
            
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            const name = document.getElementById('test-name').value;
            const role = document.getElementById('test-role').value;
            
            try {
                // Step 1: Create user with Firebase Auth
                addResult('Step 1: Creating user with Firebase Auth...', 'info', 'test-results');
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                addResult('‚úÖ Firebase Auth user created', 'success', 'test-results');
                
                // Step 2: Create user document in Firestore
                addResult('Step 2: Creating user document in Firestore...', 'info', 'test-results');
                await db.collection('users').doc(user.uid).set({
                    email: user.email,
                    name: name,
                    role: role,
                    createdAt: new Date().toISOString(),
                    profilePicture: null
                });
                addResult('‚úÖ Firestore user document created', 'success', 'test-results');
                
                // Step 3: Verify the user document
                addResult('Step 3: Verifying user document...', 'info', 'test-results');
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    addResult('‚úÖ User document verified', 'success', 'test-results');
                    addResult(`User data: ${JSON.stringify(userDoc.data(), null, 2)}`, 'info', 'test-results');
                }
                
                addResult('üéâ Complete registration test SUCCESSFUL!', 'success', 'test-results');
                
                // Clean up
                await db.collection('users').doc(user.uid).delete();
                await user.delete();
                addResult('üóëÔ∏è Test data cleaned up', 'success', 'test-results');
                
            } catch (error) {
                addResult(`‚ùå Registration test failed: ${error.message}`, 'error', 'test-results');
                addResult(`Error code: ${error.code}`, 'error', 'test-results');
                
                if (error.code === 'permission-denied') {
                    addResult('üîß SOLUTION: Update your Firestore rules to allow user document creation!', 'warning', 'test-results');
                }
            }
        }

        async function runDiagnostic() {
            addResult('üîç Running comprehensive diagnostic...', 'info');
            
            // Test 1: Connection
            await testConnection();
            
            // Test 2: Firebase config
            await checkFirebaseConfig();
            
            // Test 3: Basic auth
            await testBasicAuth();
            
            // Test 4: Firestore rules
            await checkFirestoreRules();
            
            addResult('üéØ Diagnostic complete! Check results above.', 'success');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            addResult('üîß User Registration Debugger initialized', 'info');
            addResult('üìã Ready to diagnose registration issues', 'info');
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; }
        .error { color: red; background: #ffebee; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { color: green; background: #e8f5e8; padding: 10px; margin: 10px 0; border-radius: 5px; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; margin: 10px 0; }
    </style>
    
    <!-- Firebase SDK Bundle - All-in-One -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase.js"></script>
    
    <!-- Firebase Configuration Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/firebase-data-manager-v8.js"></script>
</head>
<body>
    <h1>üîç User Profile Debug Tool</h1>
    
    <div id="status">Initializing...</div>
    
    <button onclick="checkCurrentUser()">Check Current User</button>
    <button onclick="listAllUsers()">List All Users in Database</button>
    <button onclick="testRedirect()">Test Redirect Logic</button>
    
    <div class="debug">
        <h3>Debug Information:</h3>
        <div id="debugInfo">Loading...</div>
    </div>

    <script>
        let firebaseDataManager = null;
        
        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = type;
            console.log(message);
        }
        
        function updateDebugInfo(info) {
            const debugEl = document.getElementById('debugInfo');
            debugEl.innerHTML += `<p><strong>${new Date().toLocaleTimeString()}:</strong> ${info}</p>`;
            console.log('DEBUG:', info);
        }
        
        async function init() {
            try {
                updateStatus('üî• Waiting for Firebase to be ready...');
                updateDebugInfo('Starting initialization');
                
                let attempts = 0;
                while (!window.firebaseReady && attempts < 100) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.firebaseReady) {
                    throw new Error('Firebase initialization timeout');
                }
                
                firebaseDataManager = new FirebaseDataManager();
                await firebaseDataManager.initialize();
                
                updateStatus('‚úÖ Firebase ready!', 'success');
                updateDebugInfo('Firebase DataManager initialized');
                
                // Check if there's already a user signed in
                checkCurrentUser();
                
            } catch (error) {
                updateStatus(`‚ùå Error: ${error.message}`, 'error');
                updateDebugInfo(`Initialization failed: ${error.message}`);
            }
        }
        
        async function checkCurrentUser() {
            try {
                updateDebugInfo('=== CHECKING CURRENT USER ===');
                
                if (!firebaseDataManager) {
                    updateDebugInfo('ERROR: FirebaseDataManager not initialized');
                    return;
                }
                
                const currentUser = firebaseDataManager.currentUser;
                
                if (currentUser) {
                    updateDebugInfo(`‚úÖ Current user found: ${currentUser.email} (UID: ${currentUser.uid})`);
                    
                    // Get user profile
                    const userProfile = await firebaseDataManager.getUserProfile(currentUser.uid);
                    updateDebugInfo(`User profile result: ${JSON.stringify(userProfile, null, 2)}`);
                    
                    if (userProfile.success && userProfile.data) {
                        const role = userProfile.data.role;
                        updateDebugInfo(`‚úÖ User role: ${role}`);
                        updateDebugInfo(`‚úÖ User data: ${JSON.stringify(userProfile.data, null, 2)}`);
                        
                        // Test redirect logic
                        if (role === 'teacher') {
                            updateDebugInfo('üéØ Would redirect to: pages/teacher-dashboard.html');
                        } else if (role === 'student') {
                            updateDebugInfo('üéØ Would redirect to: pages/student-dashboard.html');
                        } else {
                            updateDebugInfo(`‚ùå Unknown role: ${role}`);
                        }
                    } else {
                        updateDebugInfo(`‚ùå Failed to get user profile: ${userProfile.error || 'Unknown error'}`);
                    }
                } else {
                    updateDebugInfo('‚ùå No current user found');
                }
                
            } catch (error) {
                updateDebugInfo(`‚ùå Error checking current user: ${error.message}`);
            }
        }
        
        async function listAllUsers() {
            try {
                updateDebugInfo('=== LISTING ALL USERS ===');
                
                if (!firebaseDataManager || !firebaseDataManager.db) {
                    updateDebugInfo('ERROR: Database not available');
                    return;
                }
                
                const usersSnapshot = await firebaseDataManager.db.collection('users').limit(10).get();
                
                updateDebugInfo(`Found ${usersSnapshot.docs.length} users in database:`);
                
                usersSnapshot.docs.forEach((doc, index) => {
                    const userData = doc.data();
                    updateDebugInfo(`${index + 1}. ID: ${doc.id}`);
                    updateDebugInfo(`   Email: ${userData.email || 'N/A'}`);
                    updateDebugInfo(`   Role: ${userData.role || 'N/A'}`);
                    updateDebugInfo(`   Name: ${userData.fullName || userData.firstName + ' ' + userData.lastName || 'N/A'}`);
                    updateDebugInfo(`   Created: ${userData.createdAt || 'N/A'}`);
                    updateDebugInfo('   ---');
                });
                
            } catch (error) {
                updateDebugInfo(`‚ùå Error listing users: ${error.message}`);
            }
        }
        
        async function testRedirect() {
            try {
                updateDebugInfo('=== TESTING REDIRECT LOGIC ===');
                
                const currentUser = firebaseDataManager?.currentUser;
                if (!currentUser) {
                    updateDebugInfo('‚ùå No user signed in - cannot test redirect');
                    return;
                }
                
                updateDebugInfo('Getting user profile for redirect test...');
                const userProfile = await firebaseDataManager.getUserProfile(currentUser.uid);
                
                updateDebugInfo('Simulating redirect logic...');
                
                if (userProfile.success && userProfile.data && userProfile.data.role) {
                    const role = userProfile.data.role;
                    updateDebugInfo(`‚úÖ User role detected: ${role}`);
                    
                    let redirectUrl = '';
                    if (role === 'teacher') {
                        redirectUrl = 'pages/teacher-dashboard.html';
                        updateDebugInfo('üéØ Would redirect to teacher dashboard');
                    } else if (role === 'student') {
                        redirectUrl = 'pages/student-dashboard.html';
                        updateDebugInfo('üéØ Would redirect to student dashboard');
                    } else {
                        updateDebugInfo(`‚ùå Unknown role: ${role}`);
                        return;
                    }
                    
                    updateDebugInfo(`Final redirect URL: ${redirectUrl}`);
                    
                    // Actually perform the redirect for testing
                    updateDebugInfo('üöÄ Performing actual redirect in 3 seconds...');
                    setTimeout(() => {
                        updateDebugInfo(`Redirecting to: ${redirectUrl}`);
                        window.location.href = redirectUrl;
                    }, 3000);
                    
                } else {
                    updateDebugInfo('‚ùå No valid role found in user profile');
                    updateDebugInfo(`Profile data: ${JSON.stringify(userProfile)}`);
                }
                
            } catch (error) {
                updateDebugInfo(`‚ùå Error testing redirect: ${error.message}`);
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
